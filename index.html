<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Velden Health – IL BH NPI Scraper</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      background: #f7f7f7;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    .controls {
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      padding: 8px 14px;
      border-radius: 4px;
      border: 1px solid #888;
      cursor: pointer;
      background: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    label {
      font-size: 14px;
    }
    input[type="number"] {
      width: 80px;
      padding: 4px;
    }
    #status {
      margin-top: 6px;
      font-size: 13px;
      color: #555;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      margin-top: 16px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .fit-high {
      background: #d6f5d6;
    }
    .fit-medium {
      background: #fff7d6;
    }
    .fit-low {
      background: #f5d6d6;
    }
    .small {
      font-size: 11px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Velden Health – Illinois Behavioral Health NPI Scraper</h1>
  <p class="small">
    Fetches Illinois <strong>organization</strong> NPIs with taxonomy <strong>Clinic/Center – Mental Health (261QM0801X)</strong>
    and gives a rough “Velden fit” guess. You still need to Google for exact websites and do manual validation.
  </p>

  <div class="controls">
    <button id="fetchBtn">Fetch IL Mental Health Clinics (NPI-2)</button>
    <label>
      Limit:
      <input type="number" id="limitInput" value="50" min="1" max="200" />
    </label>
    <button id="clearBtn">Clear Table</button>
  </div>

  <div id="status"></div>

  <table id="resultsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Clinic Name</th>
        <th>Address</th>
        <th>Phone</th>
        <th>Taxonomy</th>
        <th>Velden Fit?</th>
        <th>Notes / Website (manual)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const fetchBtn = document.getElementById("fetchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const limitInput = document.getElementById("limitInput");
    const statusEl = document.getElementById("status");
    const tbody = document.querySelector("#resultsTable tbody");

    // Heuristic: guess how good a lead this is for Velden
    function guessVeldenFit(orgName, taxonomies) {
      const name = (orgName || "").toLowerCase();
      const taxDesc = (taxonomies && taxonomies[0] && taxonomies[0].desc || "").toLowerCase();

      let score = 0;
      let reasons = [];

      // Base: if taxonomy mentions mental or behavioral health, bump
      if (taxDesc.includes("mental") || taxDesc.includes("behavioral")) {
        score += 2;
        reasons.push("Taxonomy mental/behavioral health");
      }

      // Name keywords
      const keywordsStrong = ["behavioral", "behavioural", "counseling", "counselling", "therapy", "therapies", "psychiatry", "psychological", "mental health"];
      const keywordsMedium = ["wellness", "mind", "psych"];

      if (keywordsStrong.some(k => name.includes(k))) {
        score += 2;
        reasons.push("Name contains strong BH keyword");
      } else if (keywordsMedium.some(k => name.includes(k))) {
        score += 1;
        reasons.push("Name contains medium BH keyword");
      }

      // Penalize if clearly hospital/huge system language
      const bigSystemWords = ["hospital", "medical center", "university", "system", "state of", "county health"];
      if (bigSystemWords.some(k => name.includes(k))) {
        score -= 2;
        reasons.push("Likely large system (name)");
      }

      let fitClass = "fit-medium";
      let label = "Maybe";

      if (score >= 3) {
        fitClass = "fit-high";
        label = "High (likely small BH clinic)";
      } else if (score <= 0) {
        fitClass = "fit-low";
        label = "Low (probably not a small BH practice)";
      }

      return {
        score,
        label,
        reasons: reasons.join("; "),
        fitClass
      };
    }

    function formatAddress(addressObj) {
      if (!addressObj) return "";
      const parts = [
        addressObj.address_1,
        addressObj.address_2,
        addressObj.city,
        addressObj.state,
        addressObj.postal_code
      ].filter(Boolean);

      return parts.join(", ");
    }

    function formatTaxonomy(taxonomies) {
      if (!taxonomies || !taxonomies.length) return "";
      // Prefer primary taxonomy
      const primary = taxonomies.find(t => t.primary) || taxonomies[0];
      return primary.desc || "";
    }

    async function fetchNpiData() {
      const limit = parseInt(limitInput.value, 10) || 50;
      statusEl.textContent = "Fetching from NPI Registry API...";
      fetchBtn.disabled = true;

      try {
        // NPI-2 = organization; taxonomy 261QM0801X = Clinic/Center – Mental Health
        const url = `https://npiregistry.cms.hhs.gov/api/?version=2.1&state=IL&enumeration_type=NPI-2&taxonomy=261QM0801X&limit=${limit}`;
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        const results = data.results || [];
        statusEl.textContent = `Fetched ${results.length} records. Rendering table…`;

        tbody.innerHTML = ""; // clear

        results.forEach((r, idx) => {
          const basic = r.basic || {};
          const orgName = basic.organization_name || basic.name || "(No name)";
          const addresses = r.addresses || [];
          const locationAddress = addresses.find(a => a.address_purpose === "LOCATION") || addresses[0] || {};
          const phone = locationAddress.telephone_number || "";

          const taxonomies = r.taxonomies || [];
          const taxonomyText = formatTaxonomy(taxonomies);

          const fit = guessVeldenFit(orgName, taxonomies);

          const tr = document.createElement("tr");
          if (fit.fitClass) {
            tr.classList.add(fit.fitClass);
          }

          const idxTd = document.createElement("td");
          idxTd.textContent = idx + 1;

          const nameTd = document.createElement("td");
          nameTd.textContent = orgName;

          const addrTd = document.createElement("td");
          addrTd.textContent = formatAddress(locationAddress);

          const phoneTd = document.createElement("td");
          phoneTd.textContent = phone;

          const taxTd = document.createElement("td");
          taxTd.textContent = taxonomyText;

          const fitTd = document.createElement("td");
          fitTd.innerHTML = `<strong>${fit.label}</strong><br/><span class="small">${fit.reasons}</span>`;

          const notesTd = document.createElement("td");
          notesTd.innerHTML = '<span class="small">Add website + notes manually after Googling the clinic.</span>';

          tr.appendChild(idxTd);
          tr.appendChild(nameTd);
          tr.appendChild(addrTd);
          tr.appendChild(phoneTd);
          tr.appendChild(taxTd);
          tr.appendChild(fitTd);
          tr.appendChild(notesTd);

          tbody.appendChild(tr);
        });

        if (!results.length) {
          statusEl.textContent = "No results returned. Check filters or try again.";
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error fetching from NPI Registry. Check console/logs.";
      } finally {
        fetchBtn.disabled = false;
      }
    }

    fetchBtn.addEventListener("click", fetchNpiData);
    clearBtn.addEventListener("click", () => {
      tbody.innerHTML = "";
      statusEl.textContent = "Cleared table.";
    });
  </script>
</body>
</html>
